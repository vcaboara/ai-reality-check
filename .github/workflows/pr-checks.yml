name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate PR title follows conventional commits
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
          
      - name: Check for CHANGELOG update
        run: |
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "CHANGELOG.md"; then
            echo "✓ CHANGELOG.md updated"
          else
            echo "⚠ Warning: CHANGELOG.md not updated"
            echo "Consider updating CHANGELOG.md with your changes"
          fi
        shell: bash
        continue-on-error: true
        
      - name: Check PR size
        run: |
          CHANGES=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1 | awk '{print $4+$6}')
          echo "Total changes: $CHANGES lines"
          if [ "$CHANGES" -gt 500 ]; then
            echo "⚠ Warning: PR is large ($CHANGES lines). Consider breaking it into smaller PRs."
          else
            echo "✓ PR size is reasonable"
          fi
        shell: bash

  file-changes:
    name: Check File Changes
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v45
        with:
          files: |
            src/**/*.py
            config/**/*.yaml
            .github/**
            
      - name: List changed files
        run: |
          echo "Changed files:"
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "  - $file"
          done
